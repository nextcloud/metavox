{"version":3,"file":"index.cjs","sources":["../lib/client.ts","../lib/interceptors/csrf-token.ts","../lib/interceptors/maintenance-mode.ts","../lib/interceptors/not-logged-in.ts","../lib/index.ts"],"sourcesContent":["/*!\n * SPDX-License-Identifier: GPL-3.0-or-later\n * SPDX-FileCopyrightText: 2025 Nextcloud GmbH and Nextcloud contributors\n */\n\nimport type { AxiosInstance, CancelTokenStatic } from 'axios'\n\nimport { getRequestToken, onRequestTokenUpdate } from '@nextcloud/auth'\nimport Axios from 'axios'\n\nexport interface CancelableAxiosInstance extends AxiosInstance {\n\tCancelToken: CancelTokenStatic\n\tisCancel: typeof Axios.isCancel\n}\n\nconst client = Axios.create({\n\theaders: {\n\t\trequesttoken: getRequestToken() ?? '',\n\t\t'X-Requested-With': 'XMLHttpRequest',\n\t},\n})\n\nonRequestTokenUpdate((token: string) => {\n\tclient.defaults.headers.requesttoken = token\n})\n\nexport const cancelableClient: CancelableAxiosInstance = Object.assign(client, {\n\tCancelToken: Axios.CancelToken,\n\tisCancel: Axios.isCancel,\n})\n","/**\n * SPDX-FileCopyrightText: 2022-2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: GPL-3.0-or-later\n */\n\nimport type { CancelableAxiosInstance } from '../client.ts'\nimport type { InterceptorErrorHandler } from './index.ts'\n\nimport { generateUrl } from '@nextcloud/router'\nimport { isAxiosError } from 'axios'\n\nconst RETRY_KEY = Symbol('csrf-retry')\n\n/**\n * Handle CSRF token errors in Axios requests.\n *\n * @param axios - The axios instance the interceptor is attached to\n */\nexport function onCsrfTokenError(axios: CancelableAxiosInstance): InterceptorErrorHandler {\n\treturn async (error: unknown) => {\n\t\tif (!isAxiosError(error)) {\n\t\t\tthrow error\n\t\t}\n\n\t\tconst { config, response, request } = error\n\t\tconst responseURL = request?.responseURL\n\n\t\tif (config\n\t\t\t&& !config[RETRY_KEY]\n\t\t\t&& response?.status === 412\n\t\t\t&& response?.data?.message === 'CSRF check failed'\n\t\t) {\n\t\t\tconsole.warn(`Request to ${responseURL} failed because of a CSRF mismatch. Fetching a new token`)\n\n\t\t\tconst { data: { token } } = await axios.get(generateUrl('/csrftoken'))\n\t\t\tconsole.debug(`New request token ${token} fetched`)\n\t\t\taxios.defaults.headers.requesttoken = token\n\n\t\t\treturn axios({\n\t\t\t\t...config,\n\t\t\t\theaders: {\n\t\t\t\t\t...config.headers,\n\t\t\t\t\trequesttoken: token,\n\t\t\t\t},\n\t\t\t\t[RETRY_KEY]: true,\n\t\t\t})\n\t\t}\n\n\t\tthrow error\n\t}\n}\n","/**\n * SPDX-FileCopyrightText: 2022-2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: GPL-3.0-or-later\n */\n\nimport type { CancelableAxiosInstance } from '../client.ts'\nimport type { InterceptorErrorHandler } from './index.ts'\n\nimport { isAxiosError } from 'axios'\n\nexport const RETRY_DELAY_KEY = Symbol('retryDelay')\n\n/**\n * Handles Nextcloud maintenance mode errors in Axios requests.\n *\n * @param axios - The current Axios instance\n */\nexport function onMaintenanceModeError(axios: CancelableAxiosInstance): InterceptorErrorHandler {\n\treturn async (error: unknown) => {\n\t\tif (!isAxiosError(error)) {\n\t\t\tthrow error\n\t\t}\n\n\t\tconst { config, response, request } = error\n\t\tconst responseURL = request?.responseURL\n\t\tconst status = response?.status\n\t\tconst headers = response?.headers\n\t\tlet retryDelay = typeof config?.[RETRY_DELAY_KEY] === 'number'\n\t\t\t? config?.[RETRY_DELAY_KEY]\n\t\t\t: 1\n\n\t\t/**\n\t\t * Retry requests if they failed due to maintenance mode\n\t\t *\n\t\t * The delay is exponential. It starts at 2s and then doubles\n\t\t * until a final retry after 32s. This results in roughly 1m of\n\t\t * retries until we give up and throw the axios error towards\n\t\t * the caller.\n\t\t */\n\t\tif (status === 503\n\t\t\t&& headers?.['x-nextcloud-maintenance-mode'] === '1'\n\t\t\t&& config?.retryIfMaintenanceMode\n\t\t) {\n\t\t\tretryDelay *= 2\n\t\t\tif (retryDelay > 32) {\n\t\t\t\tconsole.error('Retry delay exceeded one minute, giving up.', { responseURL })\n\t\t\t\tthrow error\n\t\t\t}\n\n\t\t\tconsole.warn(`Request to ${responseURL} failed because of maintenance mode. Retrying in ${retryDelay}s`)\n\t\t\tawait new Promise((resolve) => {\n\t\t\t\tsetTimeout(resolve, retryDelay * 1000)\n\t\t\t})\n\n\t\t\treturn axios({\n\t\t\t\t...config,\n\t\t\t\t[RETRY_DELAY_KEY]: retryDelay,\n\t\t\t})\n\t\t}\n\n\t\tthrow error\n\t}\n}\n","/**\n * SPDX-FileCopyrightText: 2022-2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: GPL-3.0-or-later\n */\n\nimport { isAxiosError } from 'axios'\n\n/**\n * Axios response interceptor onError callback.\n * This interceptor checks if the response failed because of a expired user session\n * and if enabled it will cause a redirect to the login.\n *\n * @param error - The response error\n */\nexport async function onNotLoggedInError(error: unknown) {\n\tif (isAxiosError(error)) {\n\t\tconst { config, response, request } = error\n\t\tconst responseURL = request?.responseURL\n\t\tconst status = response?.status\n\n\t\tif (status === 401\n\t\t\t&& response?.data?.message === 'Current user is not logged in'\n\t\t\t&& config?.reloadExpiredSession\n\t\t\t&& window?.location\n\t\t) {\n\t\t\tconsole.error(`Request to ${responseURL} failed because the user session expired. Reloading the page â€¦`)\n\n\t\t\twindow.location.reload()\n\t\t}\n\t}\n\n\tthrow error\n}\n","/**\n * SPDX-FileCopyrightText: 2020-2024 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: GPL-3.0-or-later\n */\n\nimport { cancelableClient } from './client.ts'\nimport { onCsrfTokenError } from './interceptors/csrf-token.ts'\nimport { onMaintenanceModeError } from './interceptors/maintenance-mode.ts'\nimport { onNotLoggedInError } from './interceptors/not-logged-in.ts'\n\ncancelableClient.interceptors.response.use((r) => r, onCsrfTokenError(cancelableClient))\ncancelableClient.interceptors.response.use((r) => r, onMaintenanceModeError(cancelableClient))\ncancelableClient.interceptors.response.use((r) => r, onNotLoggedInError)\n\nexport type * from 'axios'\nexport type * from './custom-config.ts'\nexport { isAxiosError, isCancel } from 'axios'\nexport default cancelableClient\n"],"names":["Axios","getRequestToken","onRequestTokenUpdate","isAxiosError","generateUrl"],"mappings":"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"}